# 段位道場 (Dan-i Dojo) 功能更新

## 功能概述

段位道場是太鼓Web的新功能，允许用户上传和游玩多曲段位考试。

## TJA 文件格式

### 必需标签

```
COURSE:Dan        // 或 COURSE:Tower
EXAM1:g,95,100,m  // 考试条件1: 魂ゲージ(准确率) ≥95%(红) ≥100%(金)
EXAM2:jp,800,900,m // 考试条件2: 良(好击数) ≥800(红) ≥900(金)
EXAM3:jb,10,5,m   // 考试条件3: 不可(失误) ≤10(红) ≤5(金)
#NEXTSONG 曲名,副标题,ジャンル,song1.ogg,0,0
// 音符数据...
#NEXTSONG 曲名2,副标题2,ジャンル,song2.ogg,0,0
// 音符数据...
```

### 考试条件类型

| 类型 | 描述 | 判定方式 |
|------|------|----------|
| `g` | 魂ゲージ (准确率%) | 良=100%, 可=50% |
| `jp` | 良 (好击数) | 越高越好 |
| `jb` | 不可 (失误数) | 越低越好 |
| `r` | 連打 (连打数) | 越高越好 |

### 条件范围 (scope)

| 范围 | 描述 |
|------|------|
| `m` | 全曲合计 (merge) |
| `l` | 每曲独立 (less) |

---

## API 文档

### 上传段位道场

**端点:** `POST /api/upload`

**请求格式:** `multipart/form-data`

**参数:**

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| `file_tja` | File | 是 | TJA 文件 (必须包含 COURSE:Dan) |
| `file_music[]` | File[] | 是 | 所有音频文件 (多个) |

**示例请求:**
```bash
curl -X POST http://localhost:5000/api/upload \
  -F "file_tja=@dan_exam.tja" \
  -F "file_music[]=@song1.ogg" \
  -F "file_music[]=@song2.ogg" \
  -F "file_music[]=@song3.ogg"
```

**成功响应:**
```json
{
  "status": "ok",
  "song_id": "abc123",
  "is_dan": true,
  "message": "アップロード成功"
}
```

**错误响应:**
```json
{
  "error": "不足しているオーディオファイル: song2.ogg"
}
```

---

## 游戏特性

### 段位道場模式特点

1. **无法暂停** - 游戏期间不能暂停
2. **条件面板** - 左下角显示实时考试条件状态
3. **颜色状态**:
   - 🟡 金色: 达成金牌条件
   - 🔴 红色: 达成合格条件  
   - ⚪ 灰色: 未达成

### 结果判定

| 结果 | 条件 |
|------|------|
| 金合格 | 所有条件达成金牌 |
| 合格 | 所有条件至少达成红牌 |
| 不合格 | 任一条件未达成 |

---

## 修改文件列表

### 后端
- `tjaf.py` - TJA解析器扩展
- `app.py` - 上传API多音频支持

### 前端
- `dan.js` - 新文件: DanExam类
- `parsetja.js` - 段位课程和#NEXTSONG解析
- `controller.js` - 段位模式初始化和暂停禁用
- `game.js` - 考试条件追踪
- `view.js` - 考试条件面板UI
- `scoresheet.js` - 段位结果判定
- `assets.js` - 加载dan.js
